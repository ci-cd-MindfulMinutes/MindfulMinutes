name: Deploy Backend

on:
  push:
    branches:
      - dev
      - main
    paths:
      - 'backend/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: false
        type: choice
        options:
          - dev
          - prod

jobs:
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Run tests
        working-directory: backend
        run: npm run test:ci

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage/
          retention-days: 30

  deploy-backend:
    name: Build and Deploy Backend
    runs-on: ubuntu-latest
    needs: [test-backend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine Environment
        id: env
        run: |
          if [[ -n "${{ github.event.inputs.environment }}" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Create ECR repository if not exists
        run: |
          aws ecr describe-repositories --repository-names mindfulminutes-${{ steps.env.outputs.environment }}-backend || \
          aws ecr create-repository --repository-name mindfulminutes-${{ steps.env.outputs.environment }}-backend

      - name: Build Docker image
        working-directory: backend
        run: |
          ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
          docker build -t ${ECR_REGISTRY}/mindfulminutes-${{ steps.env.outputs.environment }}-backend:latest .
          docker tag ${ECR_REGISTRY}/mindfulminutes-${{ steps.env.outputs.environment }}-backend:latest ${ECR_REGISTRY}/mindfulminutes-${{ steps.env.outputs.environment }}-backend:${{ github.sha }}

      - name: Push Docker image to ECR
        run: |
          ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
          docker push ${ECR_REGISTRY}/mindfulminutes-${{ steps.env.outputs.environment }}-backend:latest
          docker push ${ECR_REGISTRY}/mindfulminutes-${{ steps.env.outputs.environment }}-backend:${{ github.sha }}

      - name: Download coverage report
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage/

      - name: Get Backend EC2 Instance ID
        id: get_ec2
        run: |
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=mindfulminutes-${{ steps.env.outputs.environment }}-backend" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].InstanceId" \
            --output text)
          EC2_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=mindfulminutes-${{ steps.env.outputs.environment }}-backend" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)
          echo "instance_id=${INSTANCE_ID}" >> $GITHUB_OUTPUT
          echo "ec2_ip=${EC2_IP}" >> $GITHUB_OUTPUT

      - name: Prepare deployment package
        run: |
          # Create deployment directory
          mkdir -p deploy-package

          # Copy docker-compose file
          cp docker-compose.ec2.yml deploy-package/

          # Copy monitoring configuration
          cp -r monitoring deploy-package/

          # Copy coverage reports
          mkdir -p deploy-package/coverage
          if [ -d "backend/coverage/lcov-report" ]; then
            cp -r backend/coverage/lcov-report/* deploy-package/coverage/
          fi

          # Create tarball
          tar -czf deploy-package.tar.gz -C deploy-package .

      - name: Upload deployment package to EC2
        run: |
          # Copy deployment package to EC2 via S3
          aws s3 cp deploy-package.tar.gz s3://mindfulminutes-${{ steps.env.outputs.environment }}-frontend/deploy/deploy-package.tar.gz

      - name: Deploy to EC2
        env:
          INSTANCE_ID: ${{ steps.get_ec2.outputs.instance_id }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_NAME: mindfulminutes-${{ steps.env.outputs.environment }}-backend
          MONGO_URI: ${{ steps.env.outputs.environment == 'prod' && secrets.PROD_MONGO_URI || secrets.DEV_MONGO_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          AWS_REGION: us-east-1
          ENVIRONMENT: ${{ steps.env.outputs.environment }}
        run: |
          # Deploy using docker-compose via SSM
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${INSTANCE_ID} \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[
              'cd /home/ec2-user',
              'echo \"==================== CHECKING DOCKER-COMPOSE ====================\"',
              'if ! command -v docker-compose &> /dev/null; then echo \"Installing docker-compose...\" && sudo curl -L \"https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose && sudo chmod +x /usr/local/bin/docker-compose; fi',
              'docker-compose --version',
              'export AWS_REGION=${AWS_REGION}',
              'export ECR_REGISTRY=${ECR_REGISTRY}',
              'export ENVIRONMENT=${ENVIRONMENT}',
              'export MONGO_URI=\"${MONGO_URI}\"',
              'export JWT_SECRET=\"${JWT_SECRET}\"',
              'echo \"==================== DOWNLOADING DEPLOYMENT PACKAGE ====================\"',
              'aws s3 cp s3://mindfulminutes-${ENVIRONMENT}-frontend/deploy/deploy-package.tar.gz .',
              'echo \"==================== EXTRACTING DEPLOYMENT PACKAGE ====================\"',
              'tar -xzf deploy-package.tar.gz',
              'rm deploy-package.tar.gz',
              'echo \"==================== VERIFYING EXTRACTED FILES ====================\"',
              'ls -la',
              'ls -la monitoring/ || echo \"monitoring directory not found\"',
              'ls -la coverage/ || echo \"coverage directory not found\"',
              'echo \"==================== LOGGING INTO ECR ====================\"',
              'aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}',
              'echo \"==================== STOPPING EXISTING CONTAINERS ====================\"',
              'docker-compose -f docker-compose.ec2.yml down || true',
              'echo \"==================== PULLING BACKEND IMAGE FROM ECR ====================\"',
              'docker-compose -f docker-compose.ec2.yml pull backend || echo \"Backend pull failed, continuing...\"',
              'echo \"==================== STARTING ALL CONTAINERS ====================\"',
              'docker-compose -f docker-compose.ec2.yml up -d',
              'echo \"==================== WAITING FOR CONTAINERS TO START ====================\"',
              'sleep 10',
              'echo \"==================== CONTAINER STATUS ====================\"',
              'docker ps -a',
              'echo \"==================== DOCKER COMPOSE LOGS ====================\"',
              'docker-compose -f docker-compose.ec2.yml logs --tail=30',
              'echo \"==================== RUNNING CONTAINERS COUNT ====================\"',
              'docker ps --filter status=running --format \"{{.Names}}\" | wc -l',
              'echo \"Expected: 6 containers (backend, prometheus, grafana, node-exporter, cadvisor, coverage)\"'
            ]" \
            --output text --query 'Command.CommandId')

          echo "SSM Command ID: ${COMMAND_ID}"
          echo "Waiting for command to complete..."

          # Wait for command to complete (max 2 minutes)
          for i in {1..24}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id ${COMMAND_ID} \
              --instance-id ${INSTANCE_ID} \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            echo "Attempt $i/24: Command status: ${STATUS}"

            if [[ "${STATUS}" == "Success" ]] || [[ "${STATUS}" == "Failed" ]]; then
              break
            fi
            sleep 5
          done

          echo "==================== SSM COMMAND OUTPUT ===================="
          aws ssm get-command-invocation \
            --command-id ${COMMAND_ID} \
            --instance-id ${INSTANCE_ID} \
            --query 'StandardOutputContent' \
            --output text

          echo "==================== SSM COMMAND ERRORS ===================="
          aws ssm get-command-invocation \
            --command-id ${COMMAND_ID} \
            --instance-id ${INSTANCE_ID} \
            --query 'StandardErrorContent' \
            --output text || echo "No errors"

      - name: Deployment Success
        run: |
          echo "Backend deployed successfully to environment: ${{ steps.env.outputs.environment }}"
          echo "EC2 IP: ${{ steps.get_ec2.outputs.ec2_ip }}"
          echo "Backend API: http://${{ steps.get_ec2.outputs.ec2_ip }}:3000"
          echo "Grafana Dashboard: http://${{ steps.get_ec2.outputs.ec2_ip }}:3003"
          echo "Coverage Reports: http://${{ steps.get_ec2.outputs.ec2_ip }}:8080"
